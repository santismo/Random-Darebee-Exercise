<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ðŸ’ªRandom DAREBEE Workout Picker</title>

<style>
  :root{
    --bg:#0b0c10;
    --panel:#12141b;
    --panel2:#0f1118;
    --text:#e7e9ee;
    --muted:#a0a6b5;
    --accent:#7aa2ff;
    --border:rgba(255,255,255,.09);
    --err:#ff6b6b;
  }
  *{ box-sizing:border-box }
  body{
    margin:0;
    min-height:100vh;
    background:linear-gradient(180deg, var(--bg), #07080c);
    color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  }
  .wrap{ max-width:760px; margin:0 auto; padding:16px; }
  .card{
    background:var(--panel);
    border:1px solid var(--border);
    border-radius:14px;
    padding:14px;
    box-shadow:0 20px 60px rgba(0,0,0,.45);
  }
  h1{ margin:0 0 10px; font-size:1.15rem; font-weight:800; }

  .controls{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:10px;
  }
  @media (max-width:560px){
    .controls{ grid-template-columns:1fr; }
  }

  label{
    display:block;
    font-size:.82rem;
    color:var(--muted);
    margin-bottom:6px;
  }
  select,input{
    width:100%;
    padding:10px 12px;
    border-radius:10px;
    border:1px solid var(--border);
    background:var(--panel2);
    color:var(--text);
    outline:none;
  }
  select[multiple]{ min-height:132px; }

  .buttons{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:10px;
    margin-top:10px;
  }
  @media (max-width:560px){
    .buttons{ grid-template-columns:1fr; }
  }
  button{
    padding:11px 12px;
    border-radius:10px;
    border:none;
    background:var(--accent);
    color:#0b0c10;
    font-weight:900;
    cursor:pointer;
  }
  button.secondary{
    background:transparent;
    color:var(--text);
    border:1px solid var(--border);
    font-weight:800;
  }
  button:disabled{ opacity:.55; cursor:not-allowed; }

  #status{
    margin-top:10px;
    color:var(--muted);
    min-height:1.1em;
  }
  #status.err{ color:var(--err); }

  /* Filters collapsible area */
  #filtersWrap{
    margin-top:10px;
    padding-top:10px;
    border-top:1px solid var(--border);
  }
  .hidden{ display:none !important; }

  /* One-column list */
  .list{
    margin-top:12px;
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .item{
    display:block;
    text-decoration:none;
    color:inherit;
    background:var(--panel);
    border:1px solid var(--border);
    border-radius:14px;
    overflow:hidden;
  }
  /* NO CROPPING */
  .item img{
    width:100%;
    height:auto;
    display:block;
    object-fit:contain;
    background:#0a0b10;
  }
  .meta{
    padding:10px 12px;
    display:flex;
    flex-direction:column;
    gap:6px;
  }
  .slug{
    font-size:.86rem;
    color:var(--muted);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .tags{
    display:flex;
    flex-wrap:wrap;
    gap:6px;
  }
  .tag{
    font-size:.75rem;
    padding:3px 8px;
    border-radius:999px;
    background:rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.08);
  }
</style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <h1>Random DAREBEE Workouts</h1>

    <!-- Always-visible controls -->
    <div class="controls">
      <div>
        <label for="count">How many to display</label>
        <input id="count" type="number" min="1" max="100" value="12">
      </div>

      <div>
        <label for="mode">Mode</label>
        <select id="mode">
          <option value="total" selected>Total Random (default)</option>
          <option value="filtered">Filtered Random</option>
        </select>
      </div>
    </div>

    <!-- Filters: only shown when mode = filtered -->
    <div id="filtersWrap" class="hidden">
      <div class="controls" style="margin-top:0;">
        <div><label for="type">Type</label><select id="type" multiple></select></div>
        <div><label for="focus">Focus</label><select id="focus" multiple></select></div>
        <div><label for="difficulty">Difficulty</label><select id="difficulty" multiple></select></div>

        <div><label for="tools">Equipment Type (Tools)</label><select id="tools" multiple></select></div>

        <!-- FIX: This filter is *computed* from tools/equipment and always works -->
        <div><label for="hasTools">Equipment (Has tools?)</label>
          <select id="hasTools" multiple>
            <option value="yes">yes</option>
            <option value="no">no</option>
          </select>
        </div>

        <div><label for="specialty">Specialty</label><select id="specialty" multiple></select></div>
      </div>
    </div>

    <div class="buttons">
      <button id="go">Generate</button>
      <button id="clear" class="secondary">Clear Filters</button>
    </div>

    <div id="status"></div>
  </div>

  <div class="list" id="list"></div>
</div>

<script>
const statusEl = document.getElementById("status");
const listEl = document.getElementById("list");
const goBtn = document.getElementById("go");
const clearBtn = document.getElementById("clear");
const countEl = document.getElementById("count");
const modeEl = document.getElementById("mode");
const filtersWrap = document.getElementById("filtersWrap");

const selects = {
  type: document.getElementById("type"),
  focus: document.getElementById("focus"),
  difficulty: document.getElementById("difficulty"),
  tools: document.getElementById("tools"),           // dumbbells etc.
  hasTools: document.getElementById("hasTools"),     // derived yes/no
  specialty: document.getElementById("specialty"),
};

let WORKOUTS = null;   // array of workout page URLs
let META = null;       // normalized meta: key is workout page URL

function setStatus(t, err=false){
  statusEl.textContent = t;
  statusEl.className = err ? "err" : "";
}

async function loadJSON(name){
  const url = new URL(name, location.href).toString();
  const r = await fetch(url, { cache:"no-store", headers:{ "Accept":"application/json" }});
  if(!r.ok) throw new Error(`${name} failed (HTTP ${r.status})`);
  return r.json();
}

function workoutSlugFromUrl(pageUrl){
  try {
    const u = new URL(pageUrl);
    return u.pathname.split("/").pop().replace(/\.html$/i, "");
  } catch {
    return String(pageUrl).split("/").pop().replace(/\.html$/i, "");
  }
}

function pageToImage(pageUrl){
  const slug = workoutSlugFromUrl(pageUrl);
  return `https://darebee.com/images/workouts/${slug}.jpg`;
}

function normalizeMeta(metaRaw){
  const out = {};
  const rawEntries = Object.entries(metaRaw || {});
  const rawMap = new Map(rawEntries);

  function normFields(m){
    const mm = m || {};
    const tools = mm.tools || mm.tool || mm.equipmentType || mm.equipment_type || [];
    const norm = {
      type: mm.type || [],
      focus: mm.focus || [],
      difficulty: mm.difficulty || [],
      tools: Array.isArray(tools) ? tools.slice() : [],
      specialty: mm.specialty || [],
    };

    // If "yes/no" accidentally ended up in tools, remove it (we compute hasTools separately)
    norm.tools = norm.tools.filter(v => v !== "yes" && v !== "no");
    return norm;
  }

  for (const workoutUrl of WORKOUTS){
    const slug = workoutSlugFromUrl(workoutUrl);
    const keyFull = workoutUrl;
    const keySlug = slug;
    const keyHtml = slug + ".html";
    const keyPath = "/workouts/" + slug + ".html";

    let found = null;
    if (rawMap.has(keyFull)) found = rawMap.get(keyFull);
    else if (rawMap.has(keySlug)) found = rawMap.get(keySlug);
    else if (rawMap.has(keyHtml)) found = rawMap.get(keyHtml);
    else if (rawMap.has(keyPath)) found = rawMap.get(keyPath);

    if (!found) {
      for (const [k, v] of rawEntries) {
        if (typeof k === "string" && k.includes(slug) && k.endsWith(".html")) { found = v; break; }
      }
    }

    out[workoutUrl] = normFields(found);
  }

  return out;
}

function selected(sel){
  return Array.from(sel.selectedOptions).map(o => o.value);
}

function matches(url, filters){
  const m = META[url] || {};

  // Standard facets
  for(const facet of ["type","focus","difficulty","tools","specialty"]){
    const wanted = filters[facet] || [];
    if(!wanted.length) continue;
    const have = Array.isArray(m[facet]) ? m[facet] : [];
    if(!wanted.some(x => have.includes(x))) return false; // OR logic within facet
  }

  // Derived yes/no: "hasTools"
  const wantedHas = filters.hasTools || [];
  if (wantedHas.length) {
    const has = (Array.isArray(m.tools) && m.tools.length > 0) ? "yes" : "no";
    if (!wantedHas.includes(has)) return false;
  }

  return true;
}

function sample(arr, n){
  const k = Math.min(n, arr.length);
  const picked = new Set();
  while(picked.size < k){
    picked.add(Math.floor(Math.random() * arr.length));
  }
  return Array.from(picked).map(i => arr[i]);
}

function makeTag(text){
  const t = document.createElement("span");
  t.className = "tag";
  t.textContent = text;
  return t;
}

function makeItem(url){
  const a = document.createElement("a");
  a.className = "item";
  a.href = url;
  a.target = "_blank";
  a.rel = "noopener noreferrer";

  const img = document.createElement("img");
  img.loading = "lazy";

  const meta = document.createElement("div");
  meta.className = "meta";

  const s = document.createElement("div");
  s.className = "slug";

  const tags = document.createElement("div");
  tags.className = "tags";

  function setFromPage(pageUrl){
    a.href = pageUrl;
    s.textContent = workoutSlugFromUrl(pageUrl);
    img.src = pageToImage(pageUrl);

    tags.innerHTML = "";
    if (modeEl.value === "filtered") {
      const m = META[pageUrl] || {};
      ["type","focus","difficulty","specialty"].forEach(k=>{
        (m[k] || []).slice(0,2).forEach(v => tags.appendChild(makeTag(`${k}:${v}`)));
      });
      // show a bit of tools + derived hasTools
      (m.tools || []).slice(0,2).forEach(v => tags.appendChild(makeTag(`tools:${v}`)));
      tags.appendChild(makeTag(`hasTools:${(m.tools && m.tools.length) ? "yes" : "no"}`));
    }
  }

  img.onerror = () => {
    if(!WORKOUTS?.length) return;
    const replacement = WORKOUTS[Math.floor(Math.random() * WORKOUTS.length)];
    setFromPage(replacement);
  };

  setFromPage(url);
  meta.appendChild(s);
  meta.appendChild(tags);

  a.appendChild(img);
  a.appendChild(meta);
  return a;
}

function updateFiltersVisibility(){
  const show = modeEl.value === "filtered";
  filtersWrap.classList.toggle("hidden", !show);
  clearBtn.disabled = !show;
}

async function init(){
  try{
    modeEl.value = "total";
    updateFiltersVisibility();

    setStatus("Loading workouts + metaâ€¦");

    const w = await loadJSON("workouts.json");
    WORKOUTS = Array.isArray(w) ? w : w.urls;
    if(!Array.isArray(WORKOUTS) || !WORKOUTS.length) throw new Error("workouts.json has no URLs");

    const metaRaw = await loadJSON("meta.json");
    META = normalizeMeta(metaRaw);

    // Populate dropdown options from normalized META
    for(const facet of ["type","focus","difficulty","tools","specialty"]){
      const vals = new Set();
      for (const u of WORKOUTS){
        (META[u]?.[facet] || []).forEach(v => vals.add(v));
      }
      selects[facet].innerHTML = Array.from(vals).sort()
        .map(v => `<option value="${v}">${v}</option>`).join("");
    }

    setStatus("Ready.");
    generate();

  } catch(e){
    console.error(e);
    setStatus("Error: " + e.message, true);
    goBtn.disabled = true;
    modeEl.disabled = true;
    clearBtn.disabled = true;
  }
}

function clearFilters(){
  // Clear multi-selects
  Object.values(selects).forEach(sel => Array.from(sel.options).forEach(o => o.selected = false));
}

function generate(){
  try{
    if(!WORKOUTS || !META) { setStatus("Not loaded yet.", true); return; }

    const n = Math.max(1, Math.min(100, parseInt(countEl.value, 10) || 12));
    let pool = WORKOUTS;

    if(modeEl.value === "filtered"){
      const filters = {};
      for (const k of Object.keys(selects)) filters[k] = selected(selects[k]);
      pool = WORKOUTS.filter(u => matches(u, filters));
    }

    if(!pool.length){
      setStatus("No workouts match those filters.", true);
      listEl.innerHTML = "";
      return;
    }

    setStatus(`Showing ${Math.min(n, pool.length)} workouts (pool: ${pool.length})`);
    listEl.innerHTML = "";
    sample(pool, n).forEach(u => listEl.appendChild(makeItem(u)));

  } catch(e){
    console.error(e);
    setStatus("Error: " + e.message, true);
  }
}

goBtn.addEventListener("click", generate);

clearBtn.addEventListener("click", () => {
  clearFilters();
  setStatus("Filters cleared.");
});

modeEl.addEventListener("change", () => {
  updateFiltersVisibility();
  generate();
});

init();
</script>
</body>
</html>