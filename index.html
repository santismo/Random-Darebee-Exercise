<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Random DAREBEE Workout Picker</title>

<style>
  :root{
    --bg:#0b0c10;
    --panel:#12141b;
    --panel2:#0f1118;
    --text:#e7e9ee;
    --muted:#a0a6b5;
    --accent:#7aa2ff;
    --border:rgba(255,255,255,.09);
    --err:#ff6b6b;
  }

  *{ box-sizing:border-box }

  body{
    margin:0;
    min-height:100vh;
    background:linear-gradient(180deg, var(--bg), #07080c);
    color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  }

  .wrap{
    max-width:760px;
    margin:0 auto;
    padding:16px;
  }

  .card{
    background:var(--panel);
    border:1px solid var(--border);
    border-radius:14px;
    padding:14px;
    box-shadow:0 20px 60px rgba(0,0,0,.45);
  }

  h1{
    margin:0 0 10px;
    font-size:1.15rem;
    font-weight:800;
  }

  /* Controls */
  .controls{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:10px;
  }
  @media (max-width:560px){
    .controls{ grid-template-columns:1fr }
  }

  label{
    display:block;
    font-size:.82rem;
    color:var(--muted);
    margin-bottom:6px;
  }

  select,input{
    width:100%;
    padding:10px 12px;
    border-radius:10px;
    border:1px solid var(--border);
    background:var(--panel2);
    color:var(--text);
  }

  select[multiple]{ min-height:132px }

  .buttons{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:10px;
    margin-top:10px;
  }
  @media (max-width:560px){
    .buttons{ grid-template-columns:1fr }
  }

  button{
    padding:11px 12px;
    border-radius:10px;
    border:none;
    background:var(--accent);
    color:#0b0c10;
    font-weight:900;
    cursor:pointer;
  }

  button.secondary{
    background:transparent;
    color:var(--text);
    border:1px solid var(--border);
  }

  button:disabled{ opacity:.55; cursor:not-allowed }

  #status{
    margin-top:10px;
    color:var(--muted);
    min-height:1.1em;
  }
  #status.err{ color:var(--err) }

  /* One-column list */
  .list{
    margin-top:12px;
    display:flex;
    flex-direction:column;
    gap:10px;
  }

  .item{
    display:block;
    text-decoration:none;
    color:inherit;
    background:var(--panel);
    border:1px solid var(--border);
    border-radius:14px;
    overflow:hidden;
  }

  /* ðŸ”‘ NO CROPPING */
  .item img{
    width:100%;
    height:auto;
    display:block;
    object-fit:contain;
    background:#0a0b10;
  }

  .meta{
    padding:10px 12px;
    display:flex;
    flex-direction:column;
    gap:6px;
  }

  .slug{
    font-size:.86rem;
    color:var(--muted);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  .tags{
    display:flex;
    flex-wrap:wrap;
    gap:6px;
  }

  .tag{
    font-size:.75rem;
    padding:3px 8px;
    border-radius:999px;
    background:rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.08);
  }
</style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <h1>Random DAREBEE Workouts</h1>

    <div class="controls">
      <div>
        <label>How many to display</label>
        <input id="count" type="number" min="1" max="100" value="12">
      </div>

      <div>
        <label>Mode</label>
        <select id="mode">
          <option value="filtered">Filtered Random</option>
          <option value="total">Total Random</option>
        </select>
      </div>

      <div><label>Type</label><select id="type" multiple></select></div>
      <div><label>Focus</label><select id="focus" multiple></select></div>
      <div><label>Difficulty</label><select id="difficulty" multiple></select></div>
      <div><label>Equipment Type</label><select id="tools" multiple></select></div>
      <div><label>Equipment</label><select id="equipment" multiple></select></div>
      <div><label>Specialty</label><select id="specialty" multiple></select></div>
    </div>

    <div class="buttons">
      <button id="go">Generate</button>
      <button id="clear" class="secondary">Clear Filters</button>
    </div>

    <div id="status"></div>
  </div>

  <div class="list" id="list"></div>
</div>

<script>
const statusEl = document.getElementById("status");
const listEl = document.getElementById("list");
const goBtn = document.getElementById("go");
const clearBtn = document.getElementById("clear");
const countEl = document.getElementById("count");
const modeEl = document.getElementById("mode");

const selects = {
  type: document.getElementById("type"),
  focus: document.getElementById("focus"),
  difficulty: document.getElementById("difficulty"),
  tools: document.getElementById("tools"),
  equipment: document.getElementById("equipment"),
  specialty: document.getElementById("specialty"),
};

let WORKOUTS = null;
let META = null;

function setStatus(t, err=false){
  statusEl.textContent = t;
  statusEl.className = err ? "err" : "";
}

async function loadJSON(name){
  const url = new URL(name, location.href).toString();
  const r = await fetch(url, { cache:"no-store" });
  if(!r.ok) throw new Error(`${name} failed (${r.status})`);
  return r.json();
}

function pageToImage(url){
  const slug = url.split("/").pop().replace(".html","");
  return `https://darebee.com/images/workouts/${slug}.jpg`;
}

function slug(url){ return url.split("/").pop().replace(".html",""); }

function selected(sel){
  return Array.from(sel.selectedOptions).map(o=>o.value);
}

function matches(url, filters){
  const m = META[url] || {};
  for(const [k,v] of Object.entries(filters)){
    if(!v.length) continue;
    if(!v.some(x => (m[k]||[]).includes(x))) return false;
  }
  return true;
}

function sample(arr,n){
  const out = new Set();
  while(out.size < Math.min(n, arr.length)){
    out.add(arr[Math.floor(Math.random()*arr.length)]);
  }
  return [...out];
}

function makeItem(url){
  const a = document.createElement("a");
  a.className = "item";
  a.href = url;
  a.target = "_blank";

  const img = document.createElement("img");
  img.loading = "lazy";
  img.src = pageToImage(url);
  img.onerror = () => {
    if(WORKOUTS?.length){
      const r = WORKOUTS[Math.floor(Math.random()*WORKOUTS.length)];
      img.src = pageToImage(r);
      a.href = r;
    }
  };

  const meta = document.createElement("div");
  meta.className = "meta";

  const s = document.createElement("div");
  s.className = "slug";
  s.textContent = slug(url);

  const tags = document.createElement("div");
  tags.className = "tags";

  Object.entries(META[url]||{}).forEach(([k,v])=>{
    v.slice(0,2).forEach(x=>{
      const t=document.createElement("span");
      t.className="tag";
      t.textContent=`${k}:${x}`;
      tags.appendChild(t);
    });
  });

  meta.append(s,tags);
  a.append(img,meta);
  return a;
}

async function init(){
  try{
    setStatus("Loading dataâ€¦");
    const w = await loadJSON("workouts.json");
    WORKOUTS = Array.isArray(w)?w:w.urls;
    META = await loadJSON("meta.json");

    for(const k in selects){
      const vals = new Set();
      WORKOUTS.forEach(u => (META[u]?.[k]||[]).forEach(v=>vals.add(v)));
      selects[k].innerHTML = [...vals].sort().map(v=>`<option>${v}</option>`).join("");
    }

    setStatus("Ready.");
    generate();
  }catch(e){
    console.error(e);
    setStatus(e.message,true);
  }
}

function generate(){
  try{
    const n = Math.max(1, parseInt(countEl.value)||12);
    const filters = {};
    Object.keys(selects).forEach(k => filters[k]=selected(selects[k]));

    let pool = WORKOUTS;
    if(modeEl.value !== "total"){
      pool = WORKOUTS.filter(u => matches(u,filters));
    }

    if(!pool.length){
      setStatus("No matches.",true);
      listEl.innerHTML="";
      return;
    }

    setStatus(`Showing ${Math.min(n,pool.length)} workouts`);
    listEl.innerHTML="";
    sample(pool,n).forEach(u=>listEl.appendChild(makeItem(u)));
  }catch(e){
    console.error(e);
    setStatus(e.message,true);
  }
}

goBtn.onclick = generate;
clearBtn.onclick = () => {
  Object.values(selects).forEach(s=>[...s.options].forEach(o=>o.selected=false));
  setStatus("Filters cleared.");
};

init();
</script>
</body>
</html>